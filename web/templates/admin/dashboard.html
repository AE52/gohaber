{{ template "admin/layout.html" . }}

{{ define "embed" }}
<div class="dashboard-container">
    <!-- İstatistik Kartları -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card h-100 border-primary">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Toplam Haber</h6>
                    <h3 class="card-title">{{ .Stats.TotalArticles }}</h3>
                    <p class="card-text text-success">
                        <i class="bi bi-arrow-up-circle-fill me-1"></i>
                        {{ .Stats.NewArticlesToday }} yeni bugün
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-success">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Toplam Ziyaret</h6>
                    <h3 class="card-title">{{ .Stats.TotalViews }}</h3>
                    <p class="card-text text-success">
                        <i class="bi bi-arrow-up-circle-fill me-1"></i>
                        %{{ .Stats.ViewsIncrease }} artış
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-info">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Toplam Yorum</h6>
                    <h3 class="card-title">{{ .Stats.TotalComments }}</h3>
                    <p class="card-text text-success">
                        <i class="bi bi-arrow-up-circle-fill me-1"></i>
                        {{ .Stats.NewCommentsToday }} yeni bugün
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-warning">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Toplam Kullanıcı</h6>
                    <h3 class="card-title">{{ .Stats.TotalUsers }}</h3>
                    <p class="card-text text-success">
                        <i class="bi bi-arrow-up-circle-fill me-1"></i>
                        {{ .Stats.NewUsersToday }} yeni bugün
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- Ziyaretçi Trendi -->
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Ziyaretçi Trendi</h5>
                </div>
                <div class="card-body">
                    <canvas id="visitorsChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Son Aktiviteler -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Son Aktiviteler</h5>
                    <a href="/admin/aktiviteler" class="btn btn-sm btn-outline-primary">Tümünü Gör</a>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {{ range .RecentActivities }}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ .Title }}</h6>
                                <small class="text-muted">{{ .Time }}</small>
                            </div>
                            <p class="mb-1">{{ .Description }}</p>
                            <small class="text-muted">{{ .User }}</small>
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-3">
        <!-- Popüler İçerikler -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Popüler İçerikler</h5>
                    <a href="/admin/haberler?sort=view_count&order=desc" class="btn btn-sm btn-outline-primary">Tümünü Gör</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Başlık</th>
                                    <th>Kategori</th>
                                    <th>Görüntülenme</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{ range .PopularArticles }}
                                <tr>
                                    <td>
                                        <a href="/admin/haberler/{{ .ID }}" class="text-decoration-none">{{ .Title }}</a>
                                    </td>
                                    <td>{{ .Category.Name }}</td>
                                    <td>{{ .ViewCount }}</td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onay Bekleyen Yorumlar -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Onay Bekleyen Yorumlar</h5>
                    <a href="/admin/yorumlar?filter=pending" class="btn btn-sm btn-outline-primary">Tümünü Gör</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Kullanıcı</th>
                                    <th>İçerik</th>
                                    <th>Tarih</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{ range .PendingComments }}
                                <tr>
                                    <td>{{ .User.Username }}</td>
                                    <td>{{ .Content | truncate 30 }}</td>
                                    <td>{{ formatDate .CreatedAt }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="/admin/yorumlar/{{ .ID }}" class="btn btn-outline-primary">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button class="btn btn-outline-success" 
                                                    onclick="approveComment({{ .ID }})">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" 
                                                    onclick="deleteComment({{ .ID }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-3">
        <!-- Kategorilere Göre Haber -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Kategorilere Göre Haberler</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoriesChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Sistem Durumu -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Sistem Durumu</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table mb-0">
                        <tbody>
                            <tr>
                                <td>Uygulama Sürümü</td>
                                <td class="text-end">{{ .SystemStatus.Version }}</td>
                            </tr>
                            <tr>
                                <td>Go Sürümü</td>
                                <td class="text-end">{{ .SystemStatus.GoVersion }}</td>
                            </tr>
                            <tr>
                                <td>Veritabanı Bağlantısı</td>
                                <td class="text-end">
                                    {{ if .SystemStatus.DBConnected }}
                                    <span class="badge bg-success">Aktif</span>
                                    {{ else }}
                                    <span class="badge bg-danger">Bağlantı Yok</span>
                                    {{ end }}
                                </td>
                            </tr>
                            <tr>
                                <td>Redis Bağlantısı</td>
                                <td class="text-end">
                                    {{ if .SystemStatus.RedisConnected }}
                                    <span class="badge bg-success">Aktif</span>
                                    {{ else }}
                                    <span class="badge bg-danger">Bağlantı Yok</span>
                                    {{ end }}
                                </td>
                            </tr>
                            <tr>
                                <td>Toplam Veritabanı Boyutu</td>
                                <td class="text-end">{{ .SystemStatus.DBSize }}</td>
                            </tr>
                            <tr>
                                <td>Medya Depolama Boyutu</td>
                                <td class="text-end">{{ .SystemStatus.MediaSize }}</td>
                            </tr>
                            <tr>
                                <td>Sunucu Çalışma Süresi</td>
                                <td class="text-end">{{ .SystemStatus.Uptime }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
// Ziyaretçi Grafiği
const visitorsCtx = document.getElementById('visitorsChart').getContext('2d');
new Chart(visitorsCtx, {
    type: 'line',
    data: {
        labels: JSON.parse('{{ .VisitorStats.Labels | json }}'),
        datasets: [{
            label: 'Günlük Ziyaretçiler',
            data: JSON.parse('{{ .VisitorStats.Data | json }}'),
            fill: true,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Kategoriler Grafiği
const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');
new Chart(categoriesCtx, {
    type: 'doughnut',
    data: {
        labels: JSON.parse('{{ .CategoryStats.Labels | json }}'),
        datasets: [{
            data: JSON.parse('{{ .CategoryStats.Data | json }}'),
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(199, 199, 199, 0.6)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Yorum İşlemleri
function approveComment(id) {
    if (confirm('Bu yorumu onaylamak istediğinize emin misiniz?')) {
        fetch(`/admin/api/yorumlar/${id}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Yorum onaylama işlemi başarısız oldu.');
            }
        });
    }
}

function deleteComment(id) {
    if (confirm('Bu yorumu silmek istediğinize emin misiniz?')) {
        fetch(`/admin/api/yorumlar/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Yorum silme işlemi başarısız oldu.');
            }
        });
    }
}
</script>
{{ end }} 