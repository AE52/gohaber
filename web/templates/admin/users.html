{{ template "admin/layout.html" . }}

{{ define "embed" }}
<div class="container-fluid">
    <!-- Üst Eylem Çubuğu -->
    <div class="row mb-4">
        <div class="col-md-6 d-flex align-items-center">
            <h4 class="mb-0">Kullanıcı Yönetimi</h4>
            <span class="ms-2 badge bg-primary">{{ .TotalCount }}</span>
        </div>
        <div class="col-md-6 text-md-end">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newUserModal">
                <i class="bi bi-person-plus"></i> Yeni Kullanıcı
            </button>
            <button type="button" class="btn btn-outline-secondary ms-2" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-filter"></i> Filtreler
            </button>
            <div class="dropdown-menu dropdown-menu-end p-3" style="width: 300px;">
                <form method="GET" action="/admin/kullanicilar">
                    <div class="mb-3">
                        <label for="role" class="form-label">Rol</label>
                        <select class="form-select form-select-sm" name="role" id="role">
                            <option value="">Tümü</option>
                            <option value="admin" {{ if eq .Filters.Role "admin" }}selected{{ end }}>Admin</option>
                            <option value="editor" {{ if eq .Filters.Role "editor" }}selected{{ end }}>Editör</option>
                            <option value="user" {{ if eq .Filters.Role "user" }}selected{{ end }}>Kullanıcı</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Durum</label>
                        <select class="form-select form-select-sm" name="status" id="status">
                            <option value="">Tümü</option>
                            <option value="active" {{ if eq .Filters.Status "active" }}selected{{ end }}>Aktif</option>
                            <option value="inactive" {{ if eq .Filters.Status "inactive" }}selected{{ end }}>Pasif</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="search" class="form-label">Arama</label>
                        <input type="text" class="form-control form-control-sm" id="search" name="q" value="{{ .Filters.Query }}" placeholder="Kullanıcı adı, e-posta...">
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-sm">Uygula</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Kullanıcı Tablosu -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th style="width: 40px">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th style="width: 60px"></th>
                            <th>Kullanıcı Adı</th>
                            <th>E-posta</th>
                            <th>Tam Ad</th>
                            <th>Rol</th>
                            <th>Durum</th>
                            <th>Kayıt Tarihi</th>
                            <th style="width: 140px">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Users }}
                        <tr class="selectable-row" data-id="{{ .ID }}">
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input item-checkbox" type="checkbox" value="{{ .ID }}">
                                </div>
                            </td>
                            <td>
                                {{ if .ProfileImage }}
                                <img src="{{ .ProfileImage }}" class="rounded-circle" alt="{{ .Username }}" width="40" height="40">
                                {{ else }}
                                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                                    {{ index .FullName 0 | upper }}
                                </div>
                                {{ end }}
                            </td>
                            <td>
                                <a href="/admin/kullanicilar/{{ .ID }}" class="fw-medium text-decoration-none">{{ .Username }}</a>
                            </td>
                            <td>{{ .Email }}</td>
                            <td>{{ .FullName }}</td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-sm {{ if eq .Role "admin" }}btn-danger{{ else if eq .Role "editor" }}btn-info{{ else }}btn-secondary{{ end }} dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        {{ if eq .Role "admin" }}
                                        Admin
                                        {{ else if eq .Role "editor" }}
                                        Editör
                                        {{ else }}
                                        Kullanıcı
                                        {{ end }}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="changeRole({{ .ID }}, 'admin'); return false;">
                                                <i class="bi bi-shield-lock me-2"></i> Admin
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="changeRole({{ .ID }}, 'editor'); return false;">
                                                <i class="bi bi-pencil-square me-2"></i> Editör
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="changeRole({{ .ID }}, 'user'); return false;">
                                                <i class="bi bi-person me-2"></i> Kullanıcı
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" 
                                           id="status{{ .ID }}" {{ if eq .Status "active" }}checked{{ end }}
                                           onchange="changeStatus({{ .ID }}, this.checked ? 'active' : 'inactive')">
                                </div>
                            </td>
                            <td>{{ formatDate .CreatedAt }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="/admin/kullanicilar/{{ .ID }}" class="btn btn-outline-primary" title="Düzenle">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-warning" 
                                            data-bs-toggle="modal" data-bs-target="#resetPasswordModal" 
                                            data-id="{{ .ID }}" data-username="{{ .Username }}" title="Şifre Sıfırla">
                                        <i class="bi bi-key"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" 
                                            onclick="deleteUser({{ .ID }}, '{{ .Username }}')" title="Sil">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{ else }}
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-search fs-3 d-block mb-2"></i>
                                    <p>Arama kriterlerinize uygun kullanıcı bulunamadı.</p>
                                    <a href="/admin/kullanicilar" class="btn btn-sm btn-outline-primary">Tüm kullanıcıları göster</a>
                                </div>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            <div class="bulk-actions-wrapper">
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle bulk-actions-btn disabled" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Toplu İşlemler (<span class="count">0</span>)
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="#" onclick="bulkAction('status-active'); return false;">
                                <i class="bi bi-toggle-on me-2 text-success"></i> Aktif Yap
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="bulkAction('status-inactive'); return false;">
                                <i class="bi bi-toggle-off me-2 text-danger"></i> Pasif Yap
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="bulkAction('role-admin'); return false;">
                                <i class="bi bi-shield-lock me-2"></i> Admin Yap
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="bulkAction('role-editor'); return false;">
                                <i class="bi bi-pencil-square me-2"></i> Editör Yap
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="bulkAction('role-user'); return false;">
                                <i class="bi bi-person me-2"></i> Kullanıcı Yap
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#" onclick="bulkAction('delete'); return false;">
                                <i class="bi bi-trash me-2"></i> Sil
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Sayfalama -->
            {{ if gt .Pagination.TotalPages 1 }}
            <nav aria-label="Sayfalama">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item {{ if eq .Pagination.CurrentPage 1 }}disabled{{ end }}">
                        <a class="page-link" href="/admin/kullanicilar?page={{ sub .Pagination.CurrentPage 1 }}{{ .Pagination.QueryString }}" aria-label="Önceki">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    {{ range .Pagination.Pages }}
                    <li class="page-item {{ if eq . $.Pagination.CurrentPage }}active{{ end }}">
                        <a class="page-link" href="/admin/kullanicilar?page={{ . }}{{ $.Pagination.QueryString }}">{{ . }}</a>
                    </li>
                    {{ end }}
                    
                    <li class="page-item {{ if eq .Pagination.CurrentPage .Pagination.TotalPages }}disabled{{ end }}">
                        <a class="page-link" href="/admin/kullanicilar?page={{ add .Pagination.CurrentPage 1 }}{{ .Pagination.QueryString }}" aria-label="Sonraki">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
            {{ end }}
        </div>
    </div>
</div>

<!-- Yeni Kullanıcı Modalı -->
<div class="modal fade" id="newUserModal" tabindex="-1" aria-labelledby="newUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/admin/api/kullanicilar" method="POST" id="newUserForm" class="needs-validation" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title" id="newUserModalLabel">Yeni Kullanıcı Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">Kullanıcı Adı <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="username" name="username" required>
                        <div class="invalid-feedback">
                            Kullanıcı adı gerekli
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">E-posta <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="invalid-feedback">
                            Geçerli bir e-posta adresi girin
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Şifre <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" required>
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">
                            Şifre gerekli
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="fullName" class="form-label">Tam Ad <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="fullName" name="fullName" required>
                        <div class="invalid-feedback">
                            Tam ad gerekli
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Rol</label>
                        <select class="form-select" id="role" name="role">
                            <option value="user">Kullanıcı</option>
                            <option value="editor">Editör</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Şifre Sıfırlama Modalı -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/admin/api/kullanicilar/sifre-sifirla" method="POST" id="resetPasswordForm" class="needs-validation" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title" id="resetPasswordModalLabel">Şifre Sıfırla</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <p>
                        <strong><span id="resetPasswordUsername"></span></strong> kullanıcısının şifresini sıfırlamak üzeresiniz.
                    </p>
                    <input type="hidden" id="resetUserId" name="userId">
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Yeni Şifre <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">
                            Yeni şifre gerekli
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendEmailNotification" name="sendEmailNotification" value="1" checked>
                            <label class="form-check-label" for="sendEmailNotification">
                                Kullanıcıya e-posta bilgilendirmesi gönder
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-warning">Şifreyi Sıfırla</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Kullanıcı Silme Onay Modalı -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Kullanıcıyı Sil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <p><strong><span id="deleteUserUsername"></span></strong> kullanıcısını silmek istediğinize emin misiniz?</p>
                <p class="text-danger">Bu işlem geri alınamaz ve kullanıcının içerikleri sistemde kalacaktır.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteUserButton">Sil</button>
            </div>
        </div>
    </div>
</div>

<!-- Kullanıcı Yönetimi JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Şifre göster/gizle
    const togglePassword = document.getElementById('togglePassword');
    const toggleNewPassword = document.getElementById('toggleNewPassword');
    const password = document.getElementById('password');
    const newPassword = document.getElementById('newPassword');
    
    if (togglePassword) {
        togglePassword.addEventListener('click', function() {
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            togglePassword.innerHTML = type === 'password' ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
        });
    }
    
    if (toggleNewPassword) {
        toggleNewPassword.addEventListener('click', function() {
            const type = newPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            newPassword.setAttribute('type', type);
            toggleNewPassword.innerHTML = type === 'password' ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
        });
    }
    
    // Şifre sıfırlama modalı
    const resetPasswordModal = document.getElementById('resetPasswordModal');
    if (resetPasswordModal) {
        resetPasswordModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-id');
            const username = button.getAttribute('data-username');
            
            document.getElementById('resetUserId').value = userId;
            document.getElementById('resetPasswordUsername').textContent = username;
        });
    }
    
    // Yeni kullanıcı formu
    const newUserForm = document.getElementById('newUserForm');
    if (newUserForm) {
        newUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }
            
            const formData = new FormData(this);
            const jsonData = {};
            
            for (const [key, value] of formData.entries()) {
                jsonData[key] = value;
            }
            
            fetch('/admin/api/kullanicilar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Başarılı', 'Kullanıcı başarıyla oluşturuldu', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showNotification('Hata', data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('Hata', 'Bir hata oluştu: ' + error.message, 'error');
            });
        });
    }
    
    // Şifre sıfırlama formu
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    if (resetPasswordForm) {
        resetPasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }
            
            const formData = new FormData(this);
            const jsonData = {};
            
            for (const [key, value] of formData.entries()) {
                jsonData[key] = value;
            }
            
            fetch('/admin/api/kullanicilar/sifre-sifirla', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Başarılı', 'Şifre başarıyla sıfırlandı', 'success');
                    bootstrap.Modal.getInstance(resetPasswordModal).hide();
                } else {
                    showNotification('Hata', data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('Hata', 'Bir hata oluştu: ' + error.message, 'error');
            });
        });
    }
});

// Kullanıcı rolünü değiştirme
function changeRole(id, role) {
    fetch(`/admin/api/kullanicilar/${id}/rol`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ role: role })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Başarılı', 'Kullanıcı rolü değiştirildi', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('Hata', data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Hata', 'Bir hata oluştu: ' + error.message, 'error');
    });
}

// Kullanıcı durumunu değiştirme
function changeStatus(id, status) {
    fetch(`/admin/api/kullanicilar/${id}/durum`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Başarılı', 'Kullanıcı durumu değiştirildi', 'success');
        } else {
            showNotification('Hata', data.message, 'error');
            // Başarısız olduğunda toggle'ı eski haline getir
            const toggle = document.getElementById(`status${id}`);
            if (toggle) {
                toggle.checked = status === 'inactive';
            }
        }
    })
    .catch(error => {
        showNotification('Hata', 'Bir hata oluştu: ' + error.message, 'error');
        // Hata durumunda toggle'ı eski haline getir
        const toggle = document.getElementById(`status${id}`);
        if (toggle) {
            toggle.checked = status === 'inactive';
        }
    });
}

// Kullanıcı silme
function deleteUser(id, username) {
    const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
    document.getElementById('deleteUserUsername').textContent = username;
    
    document.getElementById('confirmDeleteUserButton').onclick = function() {
        adminAPI.deleteItem('/admin/api/kullanicilar', id, 'Bu kullanıcıyı silmek istediğinize emin misiniz?');
        modal.hide();
    };
    
    modal.show();
}

// Toplu işlem
function bulkAction(action) {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    if (ids.length === 0) {
        showNotification('Uyarı', 'Lütfen en az bir kullanıcı seçin', 'warning');
        return;
    }
    
    if (action === 'delete') {
        if (!confirm(`${ids.length} kullanıcıyı silmek istediğinize emin misiniz? Bu işlem geri alınamaz!`)) {
            return;
        }
    }
    
    adminAPI.bulkAction('/admin/api/kullanicilar/bulk', action, ids);
}
</script>
{{ end }} 