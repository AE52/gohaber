{{ template "admin/layout.html" . }}

{{ define "embed" }}
<div class="container-fluid">
    <div class="form-card">
        <form method="POST" action="{{ if .Article.ID }}/admin/haberler/{{ .Article.ID }}/update{{ else }}/admin/haberler/create{{ end }}" enctype="multipart/form-data" class="needs-validation" novalidate>
            <div class="row">
                <div class="col-md-8">
                    <!-- Ana içerik alanı -->
                    <div class="mb-4">
                        <label for="title" class="form-label">Haber Başlığı</label>
                        <input type="text" class="form-control" id="title" name="title" value="{{ .Article.Title }}" required>
                        <div class="invalid-feedback">
                            Lütfen bir başlık girin.
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="slug" class="form-label">SEO URL (Slug)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="slug" name="slug" value="{{ .Article.Slug }}" data-autogenerate="true">
                            <button class="btn btn-outline-secondary" type="button" id="generateSlug">
                                <i class="bi bi-magic"></i> Oluştur
                            </button>
                        </div>
                        <small class="text-muted">
                            Boş bırakırsanız başlıktan otomatik oluşturulacaktır.
                        </small>
                    </div>

                    <div class="mb-4">
                        <label for="summary" class="form-label">Özet</label>
                        <textarea class="form-control" id="summary" name="summary" rows="3" required>{{ .Article.Summary }}</textarea>
                        <div class="invalid-feedback">
                            Lütfen bir özet girin.
                        </div>
                        <small class="text-muted">Kısa bir özet ekleyin (max. 250 karakter).</small>
                    </div>

                    <div class="mb-4">
                        <label for="content" class="form-label">İçerik</label>
                        <textarea class="form-control content-editor" id="content" name="content" rows="12">{{ .Article.Content }}</textarea>
                        <div class="invalid-feedback">
                            Lütfen içerik girin.
                        </div>
                    </div>

                    <!-- SEO ve Üstveri Bölümü -->
                    <div class="admin-tabs">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="seo-tab" data-bs-toggle="tab" data-bs-target="#seo" type="button" role="tab" aria-controls="seo" aria-selected="true">
                                    SEO
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="meta-tab" data-bs-toggle="tab" data-bs-target="#meta" type="button" role="tab" aria-controls="meta" aria-selected="false">
                                    Üstveri
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">
                                    Gelişmiş
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content p-3" id="myTabContent">
                            <div class="tab-pane fade show active" id="seo" role="tabpanel" aria-labelledby="seo-tab">
                                <div class="mb-3">
                                    <label for="meta_title" class="form-label">Meta Başlık</label>
                                    <input type="text" class="form-control" id="meta_title" name="meta_title" value="{{ .Article.MetaTitle }}">
                                    <small class="text-muted">Boş bırakılırsa haber başlığı kullanılır.</small>
                                </div>
                                <div class="mb-3">
                                    <label for="meta_description" class="form-label">Meta Açıklama</label>
                                    <textarea class="form-control" id="meta_description" name="meta_description" rows="2">{{ .Article.MetaDescription }}</textarea>
                                    <small class="text-muted">Boş bırakılırsa özet kullanılır.</small>
                                </div>
                                <div class="mb-3">
                                    <label for="meta_keywords" class="form-label">Meta Anahtar Kelimeler</label>
                                    <input type="text" class="form-control" id="meta_keywords" name="meta_keywords" value="{{ .Article.MetaKeywords }}">
                                    <small class="text-muted">Virgülle ayırarak yazın.</small>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="meta" role="tabpanel" aria-labelledby="meta-tab">
                                <div class="mb-3">
                                    <label for="author_id" class="form-label">Yazar</label>
                                    <select class="form-select" id="author_id" name="author_id">
                                        {{ range .Authors }}
                                        <option value="{{ .ID }}" {{ if eq .ID $.Article.AuthorID }}selected{{ end }}>{{ .FullName }}</option>
                                        {{ end }}
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="created_at" class="form-label">Oluşturma Tarihi</label>
                                            <input type="datetime-local" class="form-control" id="created_at" name="created_at" value="{{ .Article.CreatedAt | formatDatetimeLocal }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="published_at" class="form-label">Yayınlanma Tarihi</label>
                                            <input type="datetime-local" class="form-control" id="published_at" name="published_at" value="{{ .Article.PublishedAt | formatDatetimeLocal }}">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured" value="1" {{ if .Article.IsFeatured }}checked{{ end }}>
                                        <label class="form-check-label" for="is_featured">
                                            Öne Çıkar
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
                                <div class="mb-3">
                                    <label for="custom_css" class="form-label">Özel CSS</label>
                                    <textarea class="form-control" id="custom_css" name="custom_css" rows="3">{{ .Article.CustomCSS }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="custom_js" class="form-label">Özel JavaScript</label>
                                    <textarea class="form-control" id="custom_js" name="custom_js" rows="3">{{ .Article.CustomJS }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Revizyonlar</label>
                                    <div class="list-group">
                                        {{ range .Revisions }}
                                        <a href="/admin/haberler/{{ $.Article.ID }}/revision/{{ .ID }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ formatDate .CreatedAt }} {{ formatTime .CreatedAt }}</h6>
                                                <small>{{ .UserName }} tarafından</small>
                                            </div>
                                            <span class="badge bg-primary rounded-pill">Görüntüle</span>
                                        </a>
                                        {{ else }}
                                        <div class="list-group-item">Revizyon bulunamadı.</div>
                                        {{ end }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <!-- Sağ yan bar -->
                    <div class="mb-4">
                        <label for="status" class="form-label">Durum</label>
                        <select class="form-select" id="status" name="status" required>
                            <option value="draft" {{ if eq .Article.Status "draft" }}selected{{ end }}>Taslak</option>
                            <option value="pending" {{ if eq .Article.Status "pending" }}selected{{ end }}>İnceleme Bekliyor</option>
                            <option value="published" {{ if eq .Article.Status "published" }}selected{{ end }}>Yayında</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="category_id" class="form-label">Kategori</label>
                        <select class="form-select" id="category_id" name="category_id" required>
                            <option value="">Kategori Seçin</option>
                            {{ range .Categories }}
                            <option value="{{ .ID }}" {{ if eq .ID $.Article.CategoryID }}selected{{ end }}>{{ .Name }}</option>
                            {{ end }}
                        </select>
                        <div class="invalid-feedback">
                            Lütfen bir kategori seçin.
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="tags" class="form-label">Etiketler</label>
                        <select class="form-select" id="tags" name="tags[]" multiple data-placeholder="Etiket seçin veya ekleyin">
                            {{ range .Tags }}
                            <option value="{{ .ID }}" {{ if $.Article.HasTag .ID }}selected{{ end }}>{{ .Name }}</option>
                            {{ end }}
                        </select>
                        <small class="text-muted">Birden fazla etiket seçebilirsiniz.</small>
                    </div>

                    <div class="mb-4">
                        <label for="featured_image" class="form-label">Öne Çıkan Görsel</label>
                        <div class="mb-2">
                            {{ if .Article.FeaturedImage }}
                            <img src="{{ .Article.FeaturedImage }}" alt="Öne Çıkan Görsel" id="featured_image_preview" class="img-fluid mb-2 border">
                            {{ else }}
                            <img src="/static/img/no-image.jpg" alt="Görsel Yok" id="featured_image_preview" class="img-fluid mb-2 border">
                            {{ end }}
                        </div>
                        <div class="input-group">
                            <button type="button" class="btn btn-outline-secondary" id="select_featured_image">
                                <i class="bi bi-images"></i> Medya Kütüphanesi
                            </button>
                            <input type="file" class="form-control" id="featured_image_upload" name="featured_image">
                            <input type="hidden" id="featured_image" name="featured_image_id" value="{{ .Article.FeaturedImageID }}">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Haber İstatistikleri</label>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Görüntülenme
                                <span class="badge bg-primary rounded-pill">{{ .Article.ViewCount }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Yorum Sayısı
                                <span class="badge bg-primary rounded-pill">{{ len .Article.Comments }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Paylaşım Sayısı
                                <span class="badge bg-primary rounded-pill">{{ .Article.ShareCount }}</span>
                            </li>
                        </ul>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Kaydet
                        </button>
                        <a href="/admin/haberler" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> İptal
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Medya Yöneticisi Modal -->
<div class="modal fade" id="mediaManagerModal" tabindex="-1" aria-labelledby="mediaManagerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaManagerModalLabel">Medya Kütüphanesi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="mediaSearchInput" placeholder="Medya ara...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="mediaTypeFilter">
                            <option value="">Tüm Türler</option>
                            <option value="image">Görsel</option>
                            <option value="video">Video</option>
                            <option value="document">Doküman</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" id="uploadMediaBtn">
                            <i class="bi bi-upload"></i> Yeni Yükle
                        </button>
                    </div>
                </div>

                <div class="media-gallery" id="mediaLibrary">
                    {{ range .MediaFiles }}
                    <div class="media-item" data-id="{{ .ID }}" data-url="{{ .Filepath }}">
                        <img src="{{ .Filepath }}" alt="{{ .Filename }}">
                        <div class="media-actions">
                            <button class="btn btn-sm btn-light select-media-btn">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </div>
                        <div class="media-info">
                            <div class="text-truncate">{{ .Filename }}</div>
                            <small class="text-muted">{{ .Filesize | formatFileSize }}</small>
                        </div>
                    </div>
                    {{ end }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- Haber Düzenleme JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // SEO URL (slug) oluşturma
    const titleInput = document.getElementById('title');
    const slugInput = document.getElementById('slug');
    const generateSlugBtn = document.getElementById('generateSlug');
    
    function createSlug(text) {
        // Türkçe karakterleri dönüştür
        const turkishChars = {'ç':'c', 'ğ':'g', 'ı':'i', 'ö':'o', 'ş':'s', 'ü':'u', 'Ç':'C', 'Ğ':'G', 'İ':'I', 'Ö':'O', 'Ş':'S', 'Ü':'U'};
        
        return text.toString().toLowerCase()
            .replace(/[çğıöşüÇĞİÖŞÜ]/g, function(letter) { return turkishChars[letter] || letter; })
            .replace(/\s+/g, '-')           // Boşlukları tire ile değiştir
            .replace(/[^\w\-]+/g, '')       // Alfanümerik ve tire dışındaki karakterleri kaldır
            .replace(/\-\-+/g, '-')         // Birden fazla tireyi tek tireye indirge
            .replace(/^-+/, '')             // Baştaki tireleri kaldır
            .replace(/-+$/, '');            // Sondaki tireleri kaldır
    }
    
    // Başlık değiştiğinde otomatik slug oluştur
    if (titleInput && slugInput) {
        titleInput.addEventListener('input', function() {
            if (slugInput.dataset.autogenerate === 'true') {
                slugInput.value = createSlug(this.value);
            }
        });
        
        // Manual slug düzenlendiğinde, otomatik oluşturmayı devre dışı bırak
        slugInput.addEventListener('input', function() {
            this.dataset.autogenerate = 'false';
        });
        
        // Slug oluştur butonuna tıklandığında
        generateSlugBtn.addEventListener('click', function() {
            slugInput.value = createSlug(titleInput.value);
            slugInput.dataset.autogenerate = 'false';
        });
    }
    
    // Öne çıkan görsel seçimi
    const selectFeaturedImageBtn = document.getElementById('select_featured_image');
    const featuredImageIdInput = document.getElementById('featured_image');
    const featuredImagePreview = document.getElementById('featured_image_preview');
    
    if (selectFeaturedImageBtn) {
        selectFeaturedImageBtn.addEventListener('click', function() {
            // Medya yöneticisi modalını aç
            const mediaModal = new bootstrap.Modal(document.getElementById('mediaManagerModal'));
            mediaModal.show();
            
            // Medya seçildiğinde
            document.querySelectorAll('.select-media-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const mediaItem = this.closest('.media-item');
                    const mediaId = mediaItem.dataset.id;
                    const mediaUrl = mediaItem.dataset.url;
                    
                    // ID ve önizleme güncelle
                    featuredImageIdInput.value = mediaId;
                    featuredImagePreview.src = mediaUrl;
                    
                    // Modalı kapat
                    mediaModal.hide();
                });
            });
        });
    }
    
    // Dosya yüklemeyle öne çıkan görsel güncelleme
    const featuredImageUpload = document.getElementById('featured_image_upload');
    if (featuredImageUpload) {
        featuredImageUpload.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    featuredImagePreview.src = e.target.result;
                    featuredImageIdInput.value = ''; // Yeni yükleme olduğunda ID'yi temizle
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
    }
    
    // Etiketler için select2 veya benzer bir kütüphane varsa
    const tagsSelect = document.getElementById('tags');
    if (tagsSelect && typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
        jQuery(tagsSelect).select2({
            tags: true,
            tokenSeparators: [','],
            placeholder: tagsSelect.dataset.placeholder
        });
    }
});
</script>
{{ end }} 